<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Quote View</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="img/alsauto.ico" />
  <style>
    :root{
      --brand:#08417a;
      --muted:#666;
      --pad:18px;
      font-family:Inter,system-ui,Arial;
    }
    html,body{height:100%;margin:0}
    body{background:#f7fafc;color:#111;font-family:Inter,system-ui,Arial;padding:20px}

    /* Container */
    .container{max-width:980px;margin:20px auto;background:#fff;border-radius:8px;padding:20px;box-shadow:0 6px 18px rgba(12,15,20,0.06)}
    .header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
    .logo img{max-width:180px;height:auto}
    .company-info{text-align:right}
    h2{color:var(--brand);margin:12px 0}
    .meta{color:var(--muted);font-size:13px}
    .section{margin-top:18px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    thead th{background:#fafafa;text-align:left;padding:10px;border-bottom:1px solid #eee;font-size:13px}
    td,th{padding:10px;border-bottom:1px solid #f6f8fb}
    .right{text-align:right}
    .totals{display:flex;justify-content:flex-end;margin-top:12px;gap:10px}
    .totals .box{min-width:260px;padding:12px;border:1px solid #f1f4f8;border-radius:6px;background:#fff}
    .small{font-size:13px;color:var(--muted)}
    .controls{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
    button{cursor:pointer;padding:8px 12px;border-radius:6px;border:1px solid #ddd;background:#fff}
    pre{white-space:pre-wrap;background:#fafafa;padding:12px;border-radius:6px;border:1px dashed #eee}

    /* ===== global loader overlay (matches system) ===== */
    #global-loader-overlay{
      position: fixed;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(15,23,42,0.38);
      z-index: 9999;
    }
    #global-loader-overlay .loader-wrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
      padding:22px 26px;
      border-radius:12px;
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(6px);
      box-shadow: 0 10px 30px rgba(2,6,23,0.3);
      min-width:220px;
      max-width:90%;
    }

    /* subtle animated three-dot loader */
    #global-loader-overlay .loader {
      width:72px;
      height:18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    #global-loader-overlay .loader span {
      display:block;
      width:12px;
      height:12px;
      border-radius:50%;
      background:#fff;
      opacity:0.85;
      transform: translateY(0);
      animation: loader-bounce 900ms infinite ease-in-out;
    }
    #global-loader-overlay .loader span:nth-child(2){ animation-delay: 120ms; }
    #global-loader-overlay .loader span:nth-child(3){ animation-delay: 240ms; }

    @keyframes loader-bounce {
      0% { transform: translateY(0); opacity: .6; }
      40% { transform: translateY(-8px); opacity: 1; }
      80% { transform: translateY(0); opacity: .6; }
      100% { transform: translateY(0); opacity: .6; }
    }

    #global-loader-overlay .loader-text {
      color: #fff;
      font-weight:700;
      font-size:14px;
      text-align:center;
    }

    /* hide content until loaded */
    #quote { display:none; }

    /* responsive tweaks */
    @media (max-width:640px){
      .container{margin:12px;padding:16px}
      #global-loader-overlay .loader { width:60px; }
    }
  </style>
</head>
<body>
  <!-- Loader overlay (visible while loading) -->
  <div id="global-loader-overlay" role="status" aria-live="polite">
    <div class="loader-wrap">
      <div class="loader" aria-hidden="true">
        <span></span><span></span><span></span>
      </div>
      <div id="loaderText" class="loader-text">Loading quote...</div>
    </div>
  </div>

  <div class="container" id="root">
    <div id="quote">
      <div class="header">
        <div class="logo">
          <img src="img/ALS AUTO.png" alt="Company logo" id="companyLogo" />
        </div>
        <div class="company-info">
          <div style="font-weight:700;color:var(--brand);">ALS Auto Services</div>
          <div class="meta">34a Central Avenue, Eastleigh, Edenvale<br/>Phone: +27 073 299 2009
                <br/>allwynsewell@gmail.com</div>
        </div>
      </div>

      <div class="section">
        <h2>Quote</h2>
        <div class="small">Quote ID: <span id="quoteIdEl"></span> &nbsp;•&nbsp; Created: <span id="quoteCreatedEl"></span></div>
        <p>Below is a quote prepared for the requested service. This is an estimate and may be subject to change following inspection.</p>
      </div>

      <div class="section" id="customerSection">
        <h3>Customer</h3>
        <div id="customerInfo" class="small"></div>
      </div>

      <div class="section" id="requestSection">
        <h3>Request & Vehicle</h3>
        <div id="requestInfo" class="small"></div>
      </div>

      <div class="section" id="itemsSection">
        <h3> Items</h3>
        <table id="itemsTable" role="table">
          <thead>
            <tr><th style="width:60%">Description</th><th style="width:15%">Quantity</th><th style="width:12%" class="right">Cost per Unit</th><th style="width:13%" class="right">Price (R)</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="section totalsWrap">
        <div class="totals">
          <div class="box">
            <div style="display:flex;justify-content:space-between"><span>Subtotal</span><strong id="subtotalVal"></strong></div>
            <div style="display:flex;justify-content:space-between;margin-top:8px"><span>VAT</span><strong id="taxVal"></strong></div>
            <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:16px"><span>Total</span><strong id="totalVal"></strong></div>
            <div style="margin-top:10px" class="small">Accepted / Paid: <span id="paidBadge"></span></div>
          </div>
        </div>
      </div>

      <div class="section" id="notesSection" style="display:none">
        <h3>Notes</h3>
        <div id="notesText" class="small"></div>
      </div>

      <div class="section" id="creatorSection" style="margin-top:18px">
        <div class="small">Created by: <span id="createdBy"></span> &nbsp;•&nbsp; Updated: <span id="updatedAt"></span></div>
      </div>

      <div class="controls">
        <button id="backBtn">Back</button>
        <button id="printBtn">Print</button>
      </div>
    </div>
  </div>

  <!-- Firebase libs -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js';
    import {
      getFirestore, doc, getDoc
    } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js';

    // config (same as other files)
    const firebaseConfig = {
      apiKey: "AIzaSyAckRXgR-_vShOB5f6VVfN9Ls01Ql9aVnI",
      authDomain: "alsauto-eeef4.firebaseapp.com",
      projectId: "alsauto-eeef4",
      storageBucket: "alsauto-eeef4.appspot.com",
      messagingSenderId: "941750657381",
      appId: "1:941750657381:web:4afd710b817bdb47fb418c",
      measurementId: "G-42ZCLHYR29"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM refs (loader overlay + text)
    const loaderOverlay = document.getElementById('global-loader-overlay');
    const loaderText = document.getElementById('loaderText');
    const quoteWrap = document.getElementById('quote');
    const quoteIdEl = document.getElementById('quoteIdEl');
    const quoteCreatedEl = document.getElementById('quoteCreatedEl');
    const customerInfoEl = document.getElementById('customerInfo');
    const requestInfoEl = document.getElementById('requestInfo');
    const itemsTbody = document.querySelector('#itemsTable tbody');
    const subtotalVal = document.getElementById('subtotalVal');
    const taxVal = document.getElementById('taxVal');
    const totalVal = document.getElementById('totalVal');
    const paidBadge = document.getElementById('paidBadge');
    const notesSection = document.getElementById('notesSection');
    const notesText = document.getElementById('notesText');
    const createdByEl = document.getElementById('createdBy');
    const updatedAtEl = document.getElementById('updatedAt');

    // small util
    function param(name='quoteId'){
      try { return new URL(location.href).searchParams.get(name); } catch(e) { return null; }
    }
    function fmtMoney(n=0){ return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }
    function fmtDate(ts){
      if(!ts) return '';
      try { if (ts.toDate) return ts.toDate().toLocaleString(); return new Date(ts).toLocaleString(); } catch(e){ return String(ts); }
    }
    function escapeHtml(s=''){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // Require admin login (same guard pattern as elsewhere)
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // redirect to login if not signed in
        loaderText.textContent = 'Not signed in. Redirecting...';
        setTimeout(()=> window.location.replace('login.html'), 900);
        return;
      }

      try {
        // optional: verify admin exists in admins collection
        const adm = await getDoc(doc(db,'admins',user.uid));
        if (!adm.exists()) {
          // not an admin -> sign out and redirect
          await signOut(auth);
          loaderText.textContent = 'Not authorized. Redirecting...';
          setTimeout(()=> window.location.replace('dashboard.html'), 900);
          return;
        }
      } catch (err) {
        console.error('admin check fail', err);
        await signOut(auth);
        loaderText.textContent = 'Auth check failed. Redirecting...';
        setTimeout(()=> window.location.replace('login.html'), 900);
        return;
      }

      // proceed to load quote
      await loadAndRenderQuote();
    });

    async function loadAndRenderQuote(){
      loaderText.textContent = 'Loading quote...';
      let quoteId = param('quoteId');
      const requestId = param('requestId');

      // If requestId provided but no quoteId, attempt to get quoteId from the request doc
      if (!quoteId && requestId) {
        try {
          const reqSnap = await getDoc(doc(db, 'quotes', requestId));
          if (reqSnap.exists()) {
            const reqData = reqSnap.data();
            if (reqData.quoteId) quoteId = reqData.quoteId;
            else {
              loaderText.textContent = 'No formal quote created for that request.';
              return;
            }
          } else {
            loaderText.textContent = 'Request not found.';
            return;
          }
        } catch (err) {
          console.error('failed to lookup request', err);
          loaderText.textContent = 'Failed to load request. See console.';
          return;
        }
      }

      if (!quoteId) {
        loaderText.textContent = 'Quote ID missing in URL.';
        return;
      }

      try {
        const qRef = doc(db, 'officialQuotes', quoteId);
        const qSnap = await getDoc(qRef);
        if (!qSnap.exists()) {
          loaderText.textContent = 'Quote not found.';
          return;
        }
        const q = qSnap.data();

        // Meta
        quoteIdEl.textContent = quoteId;
        quoteCreatedEl.textContent = fmtDate(q.createdAt);

        // Customer
        const cust = q.customer || {};
        const custHtml = `
          <div><strong>Name:</strong> ${escapeHtml(cust.name || cust.firstName + (cust.lastName ? ' ' + cust.lastName : '') || '—')}</div>
          <div><strong>Email:</strong> ${escapeHtml(cust.email || '—')}</div>
        `;
        customerInfoEl.innerHTML = custHtml;

        // Request / vehicle: if q.requestRef is a DocumentReference fetch it; else use q.requestId or fallback fields
        let reqHtml = '';
        try {
          if (q.requestRef && q.requestRef.id) {
            const reqSnap = await getDoc(q.requestRef);
            if (reqSnap.exists()) {
              const r = reqSnap.data();
              reqHtml = `
                <div><strong>Request ID:</strong> ${reqSnap.id}</div>
                <div><strong>Vehicle:</strong> ${escapeHtml(r.make || '')} ${escapeHtml(r.model || '')}</div>
                <div><strong>Service:</strong> ${escapeHtml(r.serviceType || '')} ${r.otherService ? ' — ' + escapeHtml(r.otherService) : ''}</div>
                <div><strong>Requested:</strong> ${escapeHtml(r.createdAt ? fmtDate(r.createdAt) : (r.requestedAt ? fmtDate(r.requestedAt) : '—'))}</div>
                <div><strong>Requester email:</strong> ${escapeHtml(r.email || r.requesterEmail || '—')}</div>
              `;
            } else {
              reqHtml = `<div class="small">Request reference exists but document missing.</div>`;
            }
          } else if (q.requestId) {
            const reqSnap = await getDoc(doc(db, 'quotes', q.requestId));
            if (reqSnap.exists()) {
              const r = reqSnap.data();
              reqHtml = `
                <div><strong>Request ID:</strong> ${reqSnap.id}</div>
                <div><strong>Vehicle:</strong> ${escapeHtml(r.make || '')} ${escapeHtml(r.model || '')}</div>
                <div><strong>Service:</strong> ${escapeHtml(r.serviceType || '')} ${r.otherService ? ' — ' + escapeHtml(r.otherService) : ''}</div>
                <div><strong>Requested:</strong> ${escapeHtml(r.createdAt ? fmtDate(r.createdAt) : '—')}</div>
                <div><strong>Requester email:</strong> ${escapeHtml(r.email || '—')}</div>
              `;
            } else {
              reqHtml = `<div class="small">Request data unavailable.</div>`;
            }
          } else {
            // fallback to fields present on the quote
            reqHtml = `
              <div><strong>Request ID:</strong> ${escapeHtml(q.requestId || '—')}</div>
              <div><strong>Vehicle:</strong> ${escapeHtml(q.vehicleMake || '')} ${escapeHtml(q.vehicleModel || '')}</div>
              <div><strong>Service:</strong> ${escapeHtml(q.serviceType || '')} ${q.otherService ? ' — ' + escapeHtml(q.otherService) : ''}</div>
            `;
          }
        } catch (err) {
          console.error('request fetch failed', err);
          reqHtml = `<div class="small">Failed to load request details.</div>`;
        }
        requestInfoEl.innerHTML = reqHtml;

        // Items
        itemsTbody.innerHTML = '';
        const items = q.items || [];
        for (const it of items) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(it.description || '')}</td>
            <td>${Number(it.qty || 0)}</td>
            <td class="right">${fmtMoney(it.unit || 0)}</td>
            <td class="right">${fmtMoney(it.lineTotal || 0)}</td>
          `;
          itemsTbody.appendChild(tr);
        }

        // Totals & notes & paid
        subtotalVal.textContent = fmtMoney(q.subtotal || 0);
        taxVal.textContent = fmtMoney(q.taxAmount || 0);
        totalVal.textContent = fmtMoney(q.total || 0);
        paidBadge.textContent = q.paid ? 'Yes' : 'No';

        if (q.notes) {
          notesText.textContent = q.notes;
          notesSection.style.display = 'block';
        } else {
          notesSection.style.display = 'none';
        }

        // Created by / updated
        if (q.createdBy) {
          try {
            const adminSnap = await getDoc(doc(db, 'admins', q.createdBy));
            const adminData = adminSnap.exists() ? adminSnap.data() : null;
            createdByEl.textContent = adminData ? (adminData.email || q.createdBy) : q.createdBy;
          } catch(e) {
            createdByEl.textContent = q.createdBy;
          }
        } else {
          createdByEl.textContent = '—';
        }
        updatedAtEl.textContent = fmtDate(q.updatedAt);

        // Done — hide overlay and show quote
        loaderOverlay.style.display = 'none';
        quoteWrap.style.display = 'block';

      } catch (err) {
        console.error('load quote error', err);
        loaderText.textContent = 'Failed to load quote. Check console for details.';
      }
    }

    // buttons
    document.getElementById('printBtn').addEventListener('click', () => window.print());
    document.getElementById('backBtn').addEventListener('click', () => window.close());
  </script>
</body>
</html>
